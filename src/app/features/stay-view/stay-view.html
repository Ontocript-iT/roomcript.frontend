<div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 p-4">

  <!-- ðŸ”¥ UPDATED HEADER - Removed selectors, kept title -->
  <div class="bg-white rounded-xl shadow-lg p-4 mb-4">
    <div class="flex items-center justify-between flex-wrap gap-3">
      <div class="flex items-center gap-2">
        <div class="bg-blue-500 p-2 rounded-lg">
          <mat-icon class="!text-white !w-6 !h-6 !text-[24px]">hotel</mat-icon>
        </div>
        <div>
          <h1 class="text-xl font-bold text-gray-800">Stay View</h1>
          <p class="text-xs text-gray-500 mt-0.5">
            Property: {{ propertyCode }} | {{ currentMonthYear }} | Total Reservations: {{ totalReservations }}
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- LOADING STATE -->
  <div *ngIf="loading" class="flex items-center justify-center py-16">
    <div class="text-center">
      <mat-spinner diameter="40" class="mx-auto mb-3"></mat-spinner>
      <p class="text-gray-600 font-medium text-sm">Loading stay view...</p>
    </div>
  </div>

  <!-- STAY VIEW GRID -->
  <div *ngIf="!loading" class="bg-white rounded-xl shadow-lg overflow-hidden">

    <!-- SCROLLABLE SECTION -->
    <div
      #scrollContainer
      class="overflow-x-auto relative scroll-smooth"
      (wheel)="preventScroll($event)"
      (scroll)="onScroll()">
      <div class="min-w-max">

        <!-- Date Header Row with Navigation Arrows -->
        <div class="flex border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50 sticky top-0 z-20">

          <!-- Fixed Room Type Column -->
          <div class="w-40 flex-shrink-0 p-2 font-semibold text-gray-700 border-r border-gray-200 bg-blue-100 text-sm sticky left-0 z-30">
            Room Type / Room #
          </div>

          <!-- LEFT ARROW -->
          <div class="w-12 flex-shrink-0 border-r border-gray-200 bg-blue-100 flex items-center justify-center sticky left-40 z-30">
            <button
              (click)="scrollLeft()"
              class="p-1 bg-indigo-600 hover:bg-indigo-700 rounded-full transition-all hover:scale-110 shadow-md"
              title="Previous Day">
              <mat-icon class="!text-white !w-5 !h-5 !text-[20px]">chevron_left</mat-icon>
            </button>
          </div>

          <!-- Scrollable Date Columns -->
          <div class="flex">
            <div
              *ngFor="let dateCell of dateCells"
              class="w-16 flex-shrink-0 p-1 text-center border-r border-gray-200 transition-all hover:bg-blue-100"
              [ngClass]="{
                'bg-blue-100': isWeekend(dateCell),
                'bg-yellow-50 font-medium': isToday(dateCell)
              }">
              <div class="text-[10px] font-medium text-gray-600">{{ dateCell.dayName }}</div>
              <div class="text-sm font-semibold text-gray-800 mt-0.5">{{ dateCell.date }}</div>
              <!-- ðŸ”¥ NEW: Show month name when month changes -->
              <div *ngIf="dateCell.date === 1" class="text-[9px] text-indigo-600 font-bold mt-0.5">
                {{ dateCell.fullDate | date:'MMM' }}
              </div>
            </div>
          </div>

          <!-- RIGHT ARROW -->
          <div class="w-12 flex-shrink-0 border-l border-gray-200 bg-blue-100 flex items-center justify-center sticky right-0 z-30">
            <button
              (click)="scrollRight()"
              class="p-1 bg-indigo-600 hover:bg-indigo-700 rounded-full transition-all hover:scale-110 shadow-md"
              title="Next Day">
              <mat-icon class="!text-white !w-5 !h-5 !text-[20px]">chevron_right</mat-icon>
            </button>
          </div>
        </div>

        <!-- Room Types and Reservations -->
        <div *ngFor="let roomType of roomTypes; let rtIndex = index">

          <!-- Room Type Header -->
          <div class="flex border-b border-gray-300 bg-gradient-to-r from-indigo-50 to-purple-50 cursor-pointer hover:from-indigo-100 hover:to-purple-100 transition-all"
               (click)="roomType.totalRooms > 1 ? toggleRoomType(rtIndex) : null">

            <div class="w-40 flex-shrink-0 p-2 font-bold text-gray-800 border-r border-gray-300 bg-indigo-100 text-sm sticky left-0 z-10">
              <div class="flex items-center gap-1">
                <mat-icon
                  *ngIf="roomType.totalRooms > 1"
                  class="!w-4 !h-4 !text-[16px] transition-transform"
                  [ngClass]="{'rotate-180': isRoomTypeExpanded(rtIndex)}">
                  expand_more
                </mat-icon>

                <span>{{ roomType.roomType }}</span>

                <span class="text-xs font-normal text-gray-600 ml-1">
                  ({{ roomType.totalRooms }} rooms, {{ roomType.totalReservations }} reservations)
                </span>
              </div>
            </div>

            <div class="w-12 flex-shrink-0 border-r border-gray-300 bg-indigo-100 sticky left-40 z-10"></div>
            <div class="flex flex-1"></div>
            <div class="w-12 flex-shrink-0 border-l border-gray-300 bg-indigo-100 sticky right-0 z-10"></div>
          </div>

          <!-- Individual Rooms -->
          <div *ngIf="roomType.totalRooms === 1 || isRoomTypeExpanded(rtIndex)">
            <div *ngFor="let room of roomType.rooms; let roomIndex = index">
              <div class="flex border-b border-gray-200 hover:bg-gray-50 transition-all relative">

                <div class="w-40 flex-shrink-0 p-2 border-r border-gray-200 bg-gray-50 text-sm sticky left-0 z-10">
                  <div class="flex items-center gap-2">
                    <mat-icon class="!w-4 !h-4 !text-[16px] text-blue-600">meeting_room</mat-icon>
                    <span class="font-semibold text-gray-700">{{ room.roomNumber }}</span>
                    <span class="text-xs bg-blue-100 text-blue-800 px-1 py-0.5 rounded-full">
                      {{ room.reservationCount }}
                    </span>
                  </div>
                </div>

                <div class="w-12 flex-shrink-0 border-r border-gray-200 bg-gray-50 sticky left-40 z-10"></div>

                <div class="flex flex-1 relative" style="height: 48px;">

                  <!-- Date Grid Background -->
                  <div class="absolute inset-0 flex">
                    <div
                      *ngFor="let dateCell of dateCells; let i = index"
                      class="w-16 flex-shrink-0 border-r border-gray-100 transition-colors"
                      [ngClass]="{
                          'bg-gray-50': isWeekend(dateCell),
                          'bg-yellow-50': isToday(dateCell),
                          'bg-blue-200': isCellSelected(rtIndex, roomIndex, i),
                          'cursor-pointer hover:bg-blue-50': !isCellOccupied(room, i),
                          'cursor-not-allowed': isCellOccupied(room, i)
                        }"
                      (mousedown)="!isCellOccupied(room, i) && onCellMouseDown($event, room, roomType.roomType, rtIndex, roomIndex, i)"
                      (mouseenter)="onCellMouseEnter($event, room, rtIndex, roomIndex, i)"
                      (mouseup)="onCellMouseUp($event, room, roomType.roomType)"
                      (click)="!isCellOccupied(room, i) && onEmptyCellClick($event, room, roomType.roomType, i)"
                      [title]="isCellOccupied(room, i) ? 'Cell occupied - cannot select' : 'Click or drag to add reservation or block'">
                    </div>
                  </div>

                  <!-- Reservations Overlay - Blocks empty cell clicks -->
                  <div class="absolute inset-0 p-1 pointer-events-none">
                    <div
                      *ngFor="let reservation of room.reservations; let i = index"
                      class="absolute cursor-pointer rounded-lg shadow-md hover:shadow-xl transition-all transform hover:scale-105 hover:z-10 flex items-center px-2 py-1 text-xs pointer-events-auto"
                      [ngClass]="getReservationColor(reservation)"
                      [style.left.px]="(getReservationPosition(reservation).startCol - 1) * 64 + 2"
                      [style.width.px]="getReservationPosition(reservation).spanCols * 64 - 4"
                      [style.top.px]="i * 18"
                      (click)="showReservationDetails(reservation)">
                      <div class="text-white font-semibold truncate flex items-center gap-1">
                        <mat-icon class="!w-3 !h-3 !text-[12px]">person</mat-icon>
                        {{ reservation.guestName }}
                        <span class="ml-auto bg-white/20 px-1 py-0.5 rounded text-[10px]">
                          {{ reservation.confirmationNumber.split('-')[1] }}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="w-12 flex-shrink-0 border-l border-gray-200 bg-gray-50 sticky right-0 z-10"></div>
              </div>
            </div>
          </div>

          <!-- Collapsed Summary -->
          <div *ngIf="roomType.totalRooms > 1 && !isRoomTypeExpanded(rtIndex)"
               class="flex border-b border-gray-200 bg-gray-50">
            <div class="w-40 flex-shrink-0 p-2 border-r border-gray-200 text-xs sticky left-0 z-10 bg-gray-50">
              <span class="italic text-gray-500">Click to expand {{ roomType.totalRooms }} rooms</span>
            </div>
            <div class="w-12 flex-shrink-0 border-r border-gray-200 bg-gray-50 sticky left-40 z-10"></div>
            <div class="flex flex-1 p-2 text-xs text-gray-500">
              {{ roomType.totalReservations }} total reservations across all rooms
            </div>
            <div class="w-12 flex-shrink-0 border-l border-gray-200 bg-gray-50 sticky right-0 z-10"></div>
          </div>
        </div>

      </div>
    </div>

    <!-- FIXED LEGEND -->
    <div class="flex border-t border-gray-200">
      <div class="w-40 flex-shrink-0 p-4 bg-gray-50 border-r border-gray-200">
        <div class="font-semibold text-gray-700 text-xs">Legend:</div>
      </div>

      <div class="flex flex-1 items-center gap-4 p-4 bg-gray-50 text-xs flex-wrap">
        <div class="flex items-center gap-2">
          <div class="w-3 h-3 bg-blue-500 rounded"></div>
          <span class="text-gray-600">Confirmed</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-3 h-3 bg-green-500 rounded"></div>
          <span class="text-gray-600">Checked In</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-3 h-3 bg-yellow-500 rounded"></div>
          <span class="text-gray-600">Payment Pending</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-3 h-3 bg-emerald-600 rounded"></div>
          <span class="text-gray-600">Fully Paid</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-3 h-3 bg-red-500 rounded"></div>
          <span class="text-gray-600">Cancelled</span>
        </div>
      </div>
    </div>

  </div>

  <!-- EMPTY STATE -->
  <div *ngIf="!loading && totalReservations === 0" class="bg-white rounded-xl shadow-lg p-8 text-center">
    <mat-icon class="!w-16 !h-16 !text-[64px] text-gray-300 mx-auto mb-3">event_busy</mat-icon>
    <h3 class="text-lg font-semibold text-gray-700 mb-1">No Reservations Found</h3>
    <p class="text-gray-500 text-sm">There are no reservations for the selected date range.</p>
  </div>

</div>
